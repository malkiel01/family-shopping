# הפעלת mod_rewrite
RewriteEngine On

# === אפשר גישה לקבצי PWA חשובים ===
# אפשר גישה ל-manifest.json
RewriteRule ^manifest\.json$ - [L]

# אפשר גישה ל-service-worker.js
RewriteRule ^service-worker\.js$ - [L]

# אפשר גישה לתיקיית images
RewriteRule ^images/.*\.(png|jpg|jpeg|gif|svg|ico)$ - [L]

# אפשר גישה לדף הבדיקה
RewriteRule ^check-pwa\.php$ - [L]

# אפשר גישה ל-offline.html
RewriteRule ^offline\.html$ - [L]

# === הגנות בסיסיות ===

# הגנה על קבצי ENV
<Files .env>
    Order allow,deny
    Deny from all
</Files>

# הגנה על קובץ config
<Files config.php>
    Order allow,deny
    Deny from all
</Files>

# חסימת גישה ישירה לקבצי PHP בתיקיות includes
RewriteRule ^includes/.*\.php$ - [F,L]

# חסימת גישה ישירה לקבצי דיבאג וטסט (חוץ מ-check-pwa)
RewriteCond %{REQUEST_URI} !check-pwa\.php$
RewriteRule ^(debug|test.*|find.*)\.php$ - [F,L]

# הגדרת AJAX token check - מאפשר רק בקשות AJAX לקבצים מסוימים
# אבל לא לבקשות GET רגילות
RewriteCond %{REQUEST_METHOD} POST
RewriteCond %{HTTP:X-Requested-With} !XMLHttpRequest
RewriteRule ^(dashboard|group)\.php$ - [F,L]

# הגנה על תיקיות רגישות
RewriteRule ^(vendor|logs|cache|sessions)/.*$ - [F,L]

# הפניה של כל בקשה לא מורשית ל-index
# אבל אל תפנה קבצי CSS, JS, ותמונות
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !\.(css|js|png|jpg|jpeg|gif|svg|ico|json|html)$
RewriteRule ^.*$ index.php [L]

# הגדרות אבטחה נוספות
Options -Indexes
Options -MultiViews

# הגנה על קבצי גיבוי
<FilesMatch "\.(bak|backup|sql|log|ini)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# הגדרת headers לאבטחה עם תמיכה ב-PWA
<IfModule mod_headers.c>
    Header set X-Content-Type-Options "nosniff"
    # X-Frame-Options מוגדר רק לדפים שאינם PWA
    <FilesMatch "\.php$">
        Header set X-Frame-Options "SAMEORIGIN"
    </FilesMatch>
    Header set X-XSS-Protection "1; mode=block"
    
    # Headers נוספים ל-PWA
    <FilesMatch "manifest\.json$">
        Header set Cache-Control "public, max-age=604800"
        Header set Content-Type "application/manifest+json"
    </FilesMatch>
    
    <FilesMatch "service-worker\.js$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Service-Worker-Allowed "/"
    </FilesMatch>
</IfModule>

# הגדרת MIME types נכונים
AddType application/manifest+json .json
AddType text/javascript .js
AddType text/css .css
AddType image/png .png
AddType image/jpeg .jpg .jpeg
AddType image/svg+xml .svg

# הגבלת גודל העלאות
php_value upload_max_filesize 5M
php_value post_max_size 10M

# הגדרת charset
AddDefaultCharset UTF-8

# מניעת גישה ל-git
RedirectMatch 404 /\.git

# Custom error pages - אבל לא לקבצי PWA
ErrorDocument 403 /index.php
ErrorDocument 404 /index.php
ErrorDocument 500 /index.php